{"ast":null,"code":"import { BehaviorSubject, tap } from \"rxjs\";\nimport { getApiBase } from \"./api-base\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/router\";\nexport let AuthService = /*#__PURE__*/(() => {\n  class AuthService {\n    constructor(http, router, ngZone) {\n      this.http = http;\n      this.router = router;\n      this.ngZone = ngZone;\n      this.apiUrl = `${getApiBase()}/api/auth`;\n      this.currentUserSubject = new BehaviorSubject(null);\n      this.currentUser$ = this.currentUserSubject.asObservable();\n      // Auto-logout settings\n      this.INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes\n      this.TOKEN_REFRESH_INTERVAL = 55 * 60 * 1000; // 55 minutes (refresh before expiry)\n      this.lastActivity = Date.now();\n      this.loadStoredUser();\n      this.setupInactivityTracking();\n    }\n    loadStoredUser() {\n      const token = this.getToken();\n      const userJson = localStorage.getItem(\"smartmobility_user\");\n      if (token && userJson) {\n        try {\n          const user = JSON.parse(userJson);\n          this.currentUserSubject.next(user);\n          this.startRefreshTimer();\n        } catch {\n          this.logout();\n        }\n      }\n    }\n    setupInactivityTracking() {\n      // Track user activity\n      if (typeof window !== \"undefined\") {\n        [\"mousedown\", \"keydown\", \"touchstart\", \"scroll\"].forEach(event => {\n          window.addEventListener(event, () => this.resetInactivityTimer());\n        });\n      }\n    }\n    resetInactivityTimer() {\n      this.lastActivity = Date.now();\n      if (this.isLoggedIn()) {\n        this.stopInactivityTimer();\n        this.startInactivityTimer();\n      }\n    }\n    startInactivityTimer() {\n      this.ngZone.runOutsideAngular(() => {\n        this.inactivityTimer = setTimeout(() => {\n          this.ngZone.run(() => {\n            // Check if still inactive\n            if (Date.now() - this.lastActivity >= this.INACTIVITY_TIMEOUT) {\n              this.logout(true);\n            }\n          });\n        }, this.INACTIVITY_TIMEOUT);\n      });\n    }\n    stopInactivityTimer() {\n      if (this.inactivityTimer) {\n        clearTimeout(this.inactivityTimer);\n        this.inactivityTimer = null;\n      }\n    }\n    startRefreshTimer() {\n      this.stopRefreshTimer();\n      this.ngZone.runOutsideAngular(() => {\n        this.refreshTimer = setInterval(() => {\n          this.ngZone.run(() => {\n            this.refreshToken();\n          });\n        }, this.TOKEN_REFRESH_INTERVAL);\n      });\n    }\n    stopRefreshTimer() {\n      if (this.refreshTimer) {\n        clearInterval(this.refreshTimer);\n        this.refreshTimer = null;\n      }\n    }\n    refreshToken() {\n      const refreshToken = this.getRefreshToken();\n      if (!refreshToken) return;\n      this.http.post(`${this.apiUrl}/refresh`, {\n        refreshToken\n      }).subscribe({\n        next: response => {\n          this.storeAuth(response);\n        },\n        error: () => {\n          this.logout();\n        }\n      });\n    }\n    login(request) {\n      return this.http.post(`${this.apiUrl}/login`, request).pipe(tap(response => {\n        this.storeAuth(response);\n        this.startInactivityTimer();\n        this.startRefreshTimer();\n      }));\n    }\n    register(request) {\n      return this.http.post(`${this.apiUrl}/register`, request).pipe(tap(response => {\n        this.storeAuth(response);\n        this.startInactivityTimer();\n        this.startRefreshTimer();\n      }));\n    }\n    logout(autoLogout = false) {\n      const token = this.getToken();\n      if (token) {\n        // Call logout endpoint to revoke refresh token\n        this.http.post(`${this.apiUrl}/logout`, {}).subscribe();\n      }\n      localStorage.removeItem(\"smartmobility_token\");\n      localStorage.removeItem(\"smartmobility_refresh_token\");\n      localStorage.removeItem(\"smartmobility_user\");\n      this.currentUserSubject.next(null);\n      this.stopInactivityTimer();\n      this.stopRefreshTimer();\n      if (autoLogout) {\n        alert(\"You have been logged out due to inactivity.\");\n      }\n      this.router.navigate([\"/login\"]);\n    }\n    getCurrentUser() {\n      return this.http.get(`${this.apiUrl}/me`);\n    }\n    getAllUsers() {\n      return this.http.get(`${this.apiUrl}/users`);\n    }\n    updateUserRole(userId, role) {\n      return this.http.put(`${this.apiUrl}/users/${userId}/role`, {\n        role\n      });\n    }\n    updateUserStatus(userId, isActive) {\n      return this.http.put(`${this.apiUrl}/users/${userId}/status`, {\n        isActive\n      });\n    }\n    getToken() {\n      return localStorage.getItem(\"smartmobility_token\");\n    }\n    getRefreshToken() {\n      return localStorage.getItem(\"smartmobility_refresh_token\");\n    }\n    getCurrentUserValue() {\n      return this.currentUserSubject.value;\n    }\n    isLoggedIn() {\n      return !!this.getToken();\n    }\n    isAdmin() {\n      const user = this.getCurrentUserValue();\n      return user?.role === \"Admin\";\n    }\n    isEditor() {\n      const user = this.getCurrentUserValue();\n      return user?.role === \"Admin\" || user?.role === \"Editor\";\n    }\n    hasRole(roles) {\n      const user = this.getCurrentUserValue();\n      return user ? roles.includes(user.role) : false;\n    }\n    storeAuth(response) {\n      localStorage.setItem(\"smartmobility_token\", response.token);\n      localStorage.setItem(\"smartmobility_refresh_token\", response.refreshToken);\n      localStorage.setItem(\"smartmobility_user\", JSON.stringify(response.user));\n      this.currentUserSubject.next(response.user);\n    }\n    static {\n      this.ɵfac = function AuthService_Factory(t) {\n        return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.Router), i0.ɵɵinject(i0.NgZone));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: AuthService,\n        factory: AuthService.ɵfac,\n        providedIn: \"root\"\n      });\n    }\n  }\n  return AuthService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}